#!/bin/bash -
if [ ! -n "$BASH_VERSION" ];then exec bash "$0" "$@";else set +o posix;fi
set -e
export OPENSSL_CONF=/dev/null
CERT_DIR="${CERT_DIR:-.}"

FN=
KFN=
SERIAL=

V3=no
V3HEAD=
SANLIST=
V3OPTS=
V3LIST=
V3EXTRAS=
V3CERTONLY=
V3CA=
V3CRL=
V3CAPATH=
V3CLIENT=no
V3SERVER=no
V3EMAIL=no
V3CRITICAL=no
V3NS=no

NOPKEY="$(openssl no-pkey >/dev/null 2>&1 && echo yes || echo no)"
NOECPARAM="$(openssl no-ecparam >/dev/null 2>&1 && echo yes || echo no)"
KEYPASS=
KEYPARAM=no
WANTCSR=no
MAKECSR=no
ADDDNQ=no
SHOWCSR=no
CSRTEXT=
SIGNPEM=
SINGLEUSECA=
RSABITS=2048
PKCS12FN=

# This is my default for making a key file.
if [ "$NOECPARAM" = no ] ; then
    mkkey() { openssl ecparam -name prime256v1 -genkey ;}
else
    echo "$NOECPARAM"
    mkkey() { openssl genrsa $RSABITS ; }
fi
# See also:
# mkkey() { openssl genpkey -paramfile <(openssl genpkey -genparam -algorithm ec -pkeyopt ec_paramgen_curve:prime256v1) ;}

NL='
'
X509SECT=req_x509
V3INIT="x509_extensions = $X509SECT
req_extensions = $X509SECT
[ $X509SECT ]
"

for ar
do  case "$ar" in

    -days[=:]* ) CERT_DAYS="${ar#*[=:]}" ;;
    -out[=:]* ) FN="${ar#*[=:]}" ;;
    -keyout[=:]* ) KFN="${ar#*[=:]}" ;;

    -ser[=:]??*|-serial[=:]??* ) SERIAL="${ar#*[=:]}" ;;
    -dnq ) ADDDNQ=yes ;;

    -rsa[=:]* ) eval "mkkey() { openssl genrsa '${ar#*[=:]}' ; }" ;;
    -dsa[=:]* ) eval "mkkey() { openssl dsaparam -genkey '${ar#*[=:]}' ; }" ;;
    -ec[=:]* ) 
	    ar="${ar#*[=:]}:" ; curve="${ar%%:*}"
	    ar="${ar#*:}:" ; param="${ar%%:*}"
	    ar="${ar#*:}:" ; noseed="${ar%%:*}"
	    eval "mkkey() { openssl ecparam -name '$curve' ${param:+-param_enc $param} ${noseed:+-no_seed} -genkey ; }"
	    ;;
    -rsa ) eval "mkkey() { openssl genrsa $RSABITS ; }" ;;

    -list[-_]curves|-show[_-]curves )
	openssl ecparam -list_curves ; exit ;;

    -keyfile[=:]* )
	eval "mkkey() { cat < '${ar#*[=:]}' ; }"
	[ "$KFN" = "" ] && KFN=/dev/null
	;;

    -param ) KEYPARAM=yes ;;

    -csr ) WANTCSR=yes ; MAKECSR=yes ;;
    -csrin[=:]* )
	eval "mkkey() { :; }"
	CSRFN="${ar#*[=:]}"
	KFN=/dev/null
	;;
    -showcsr ) SHOWCSR=yes ;;

    -sign[=:]*.pfx )
	SIGNPEM="$(openssl pkcs12 -nodes -in "${ar#*[=:]}")"
	MAKECSR=yes
	;;

    -sign[=:]* )
	SIGNPEM="$(cat "${ar#*[=:]}")"
	MAKECSR=yes
	;;

    -singleuseca|-suca ) MAKECSR=yes ; SINGLEUSECA=yes ;;

    -pkcs12[=:]* ) PKCS12FN="${ar#*[=:]}" ;;

    -pass[=:]*:* ) KEYPASS="${ar#*[=:]}" ;;
    -pass[=:]* ) KEYPASS="pass:${ar#*[=:]}" ;;

    -md4|-md5|-ripemd160|-sha|-sha1|-sha224|-sha256|-sha384|-sha512|-whirlpool)
	DGST=$ar ;;

    -v3 ) V3=yes ;;
    -v3ca|-ca ) V3=yes ; V3CA=yes ;;
    -v3crlsign|-crlsign|-v3crl ) V3=yes ; V3CRL=yes ;;
    -v3lastca|-lastca ) V3=yes ; V3CA=yes ; V3CAPATH=0 ;;
    -v3usr|-usr|-user ) V3=yes ; V3CA=no ;;
    -v3server|-server ) V3=yes ; V3SERVER=yes ;;
    -v3client|-client ) V3=yes ; V3CLIENT=yes ;;
    -v3email|-email ) V3=yes ; V3EMAIL=yes ;;
    -v3ns|-ns ) V3=yes ; V3NS=yes ;;
    -v3crit|-v3critical|-critical ) V3=yes ; V3CRITICAL=yes ; V3CA=${V3CA:-no} ;;

    -v3[=:]* )
	    V3=yes
	    V3LIST="$V3LIST$NL${ar#*[=:]}"
	    ;;

    -v3xt[=:]*|-xt[=:]* )
	    V3=yes
	    V3EXTRAS="$V3EXTRAS$NL${ar#*[=:]}$NL"
	    ;;

    -v3san[=:]*|-san[=:]* )
	    V3=yes
	    sanlst="${ar#*[=:]}"
	    for san in ${sanlst//,/ }
	    do  [ "$SANLIST" != "" ] && SANLIST="${SANLIST%,},"
		[ "$san" = '' -o "$san" = "$CN" ] && continue
		case "$san" in
		[0-9]*.*[0-9] ) SANLIST="${SANLIST}IP:$san" ;;
		*@* ) SANLIST="${SANLIST}email:$san" ;;
		* ) SANLIST="${SANLIST}DNS:$san" ;;
		esac
	    done
	    SANLIST="${SANLIST%,}"
	    ;;

    /*=* )
	if [ "$SUBJ" != "" ] ; then
	    echo >&1 Duplicate subject name definition ; exit 1
	fi
	SUBJ="$ar"
	;;

    -*|*/*) echo >&2 "Unknown option: $ar" ; exit 1 ;;

    * ) if [ "$SUBJ" != "" ] ; then
	    SUBJ="${SUBJ%/}/OU=$ar/"
	else
	    SUBJ="/CN=$ar/" ; CN="$ar"
	fi
	;;
    esac
done

[ "$SANLIST" != "" ] && {
    if [ "$CN" = "" ]
    then SANLIST="subjectAltName=$SANLIST"
    else SANLIST="subjectAltName=DNS:$CN,$SANLIST"
    fi
}

# Build some V3 certificate extension sets.
# Like the certificate extensions themselves this is very complex.
# Your best option is probably:
#   No option: 	A v1 certificate, usually perfectly acceptable.
#   -v3ca	A v3 CA certificate
#   -v3		An unlabeled v3 certificate; should not be used as a CA
#   -v3usr	A v3 certificate labeled as NOT a CA.
#
# This ignores the worst of the complexity, most of which was designed to
# allow CA's to charge more for "special" certificates.
#
# NOTE: Using the SAN fields forces this to be a v3 certificate.

[ "$V3" = yes ] && {
    V3HEAD="$V3INIT"
    V3XKU= ; V3EKU=
    [ "$V3CRITICAL" = yes ] && CR=critical, || CR=

    [ "$V3SERVER" = yes -o "$V3EMAIL" = yes -o "$V3CLIENT" = yes ] && {
	if [ "$SIGNPEM" != "" -o "$SINGLEUSECA" = yes ]
	then V3CA="${V3CA:-no}"
	elif [ "$V3CA" = '' ]
	then V3XKU=keyCertSign,${V3CRL:+cRLSign,}
	fi
    }

    V3P=${V3CAPATH:+, pathlen:$V3CAPATH}

    [ "$V3CA" = yes ] && V3OPTS="$V3OPTS${NL}basicConstraints = ${CR}CA:TRUE${V3P}"
    [ "$V3CA" = yes ] && V3XKU=keyCertSign,${V3CRL:+cRLSign,}
    [ "$V3CA" = no ] && V3OPTS="$V3OPTS${NL}basicConstraints = ${CR}CA:FALSE"

    if [ "$V3SERVER" = yes -a "$V3CA" != yes ]
    then
        V3OPTS="$V3OPTS${NL}keyUsage = ${CR}${V3XKU}keyEncipherment,digitalSignature,keyAgreement"
    elif [ "$V3EMAIL" = yes -a "$V3CA" != yes ]
    then
        V3OPTS="$V3OPTS${NL}keyUsage = ${CR}${V3XKU}keyEncipherment,digitalSignature"
    elif [ "$V3CLIENT" = yes -a "$V3CA" != yes ]
    then
        V3OPTS="$V3OPTS${NL}keyUsage = ${CR}${V3XKU}digitalSignature"
    elif [ "$V3XKU" != '' ]
    then
        V3OPTS="$V3OPTS${NL}keyUsage = ${CR}${V3XKU%,}"
    fi

    [ "$V3SERVER" = yes ] && V3EKU=$V3EKU,serverAuth
    [ "$V3CLIENT" = yes ] && V3EKU=$V3EKU,clientAuth
    [ "$V3EMAIL" = yes ] && V3EKU=$V3EKU,emailProtection

    if [ "$V3CA" = yes ]
    then
	[ "$V3SERVER" = yes ] && V3ENS=$V3ENS,sslCA
	[ "$V3CLIENT" = yes ] && V3ENS=$V3ENS,sslCA
	[ "$V3EMAIL" = yes ] && V3ENS=$V3ENS,emailCA
	[ "$V3SERVER" = no -a "$V3CLIENT" = no -a "$V3EMAIL" = no ] &&
	    V3ENS=$V3ENS,sslCA,emailCA
    else
	[ "$V3SERVER" = yes ] && V3ENS=$V3ENS,server
	[ "$V3CLIENT" = yes ] && V3ENS=$V3ENS,client
	[ "$V3EMAIL" = yes ] && V3ENS=$V3ENS,email
    fi

    [ "$V3EKU" != '' ] &&
	V3OPTS="$V3OPTS${NL}extendedKeyUsage = ${V3EKU#,}"

    [ "$V3NS" = yes -a "$V3ENS" != '' ] &&
	V3OPTS="$V3OPTS${NL}nsCertType = ${V3ENS#,}"

    [ "$V3CA" != '' ] && {
	V3OPTS="$V3OPTS${NL}subjectKeyIdentifier=hash"
	V3CERTONLY="$V3CERTONLY${NL}authorityKeyIdentifier=keyid,issuer${NL}"
    }
}

[ -s "$FN" ] &&
    { echo ERROR: File $FN already exists ; exit 1 ; }

[ "$MAKECSR" = yes ] && X509= || X509=-x509

[ "$ADDDNQ" = yes ] && {
    [ "$SERIAL" = "" ] &&
	SERIAL="$(openssl rand -hex 8)"
    SUBJ="${SUBJ%/}/dnQualifier=$SERIAL/"
}

mkreqconf() {
    echo '[req]'
    echo 'distinguished_name = req_distinguished_name'
    if [ "$2" != no -o "$1" = no ]
    then
	echo "$V3HEAD"
	echo "$V3OPTS"
	[ "$1" != yes ] &&
	    echo "$V3CERTONLY"
	echo "$SANLIST"
	echo "$V3LIST"
	echo "$V3EXTRAS"
    fi
    echo '[ req_distinguished_name ]'
    echo 'commonName = Common Name'
    echo 'organizationalUnitName = Organizational Unit Name'
}

SSKEY="$(mkkey)"
if [ "$CSRFN" != "" ]
then SSCERT="$(cat "$CSRFN")"
else SSCERT="$(openssl req -new $X509 $DGST \
	-days "${CERT_DAYS:-3652}" \
	${SERIAL:+-set_serial 0x"$SERIAL"} \
	${SUBJ:+-subj "$SUBJ"} \
	-key <(echo "$SSKEY") \
	-config <(mkreqconf $MAKECSR $WANTCSR) )"

    [ "$MAKECSR" = yes ] && CSRTEXT="$SSCERT"
fi

[ "$SINGLEUSECA" = yes -a "$SIGNPEM" = '' ] && {
    mksucareqconf() {
	echo '[req]'
	echo 'distinguished_name = req_distinguished_name'
	if [ "$V3CA" = no ]
	then echo "$V3INIT"
	     echo "basicConstraints = CA:TRUE"
	fi
	echo '[ req_distinguished_name ]'
	echo 'commonName = Common Name'
    }

    [ "$SERIAL" = "" ] && SERIAL="$(openssl rand -hex 9)"
    CAKEY="$(mkkey)"
    CASER="$(openssl rand -hex 8)"
    SIGNPEM="$(openssl req -new -x509 $DGST \
	    -days "${CERT_DAYS:-3652}" \
	    -set_serial 0x"$CASER" \
	    -key <(echo "$CAKEY") \
	    -subj "/CN=Private CA/dnQualifier=$SERIAL/" \
	    -config <(mksucareqconf)
	echo "$CAKEY" )"
}

[ "$SIGNPEM" != "" ] && {
    [ "$SERIAL" = "" ] && SERIAL="$(openssl rand -hex 9)"

    # Default to days left on CA certificate
    [ "$CERT_DAYS" = "" ] && {
        ENDDAY="$(date +%s --date="$(openssl x509 -noout -enddate -in <(echo "$SIGNPEM") | sed 's/^[^=]*=//')" ||:)"
        TODAY="$(date +%s)"
        [ "$ENDDAY" = "" ] && ENDDAY=2147126400
        CERT_DAYS=$((ENDDAY/86400 - TODAY/86400))
    }

    SSCERT="$(openssl x509 -req $DGST \
	    -days "${CERT_DAYS:-3652}" \
	    ${SERIAL:+-set_serial 0x"$SERIAL"} \
	    -in <(echo "$SSCERT") \
	    -CA <(echo "$SIGNPEM") \
	    -CAkey <(echo "$SIGNPEM") \
	    ${V3HEAD:+-extfile <(mkreqconf) -extensions "$X509SECT"} )"
}

[ "$PKCS12FN" != "" ] && {
    [ "$WANTCSR" = yes ] && { echo >&2 "PKCS12 files can't hold csr's"; exit 1;}
    openssl pkcs12 -export -passout pass: \
	-out "$PKCS12FN" \
	-name "$CN `date`" \
	-inkey <(echo "$SSKEY") \
	-in <(echo "$SSCERT") \
	${SIGNPEM:+-certfile <(echo "$SIGNPEM" | openssl x509) }
}

outp() {
    if [ "$WANTCSR" = yes ]
    then echo "$SSCERT" | openssl req -subject
    else echo "$SSCERT" | openssl x509 -subject -issuer -serial -dates
    fi

    [ "$SINGLEUSECA" = yes ] &&
	echo "$SIGNPEM" | openssl x509 -subject -serial -dates

    [ "$CSRTEXT" != "" -a "$SHOWCSR" = yes ] &&
	echo "$CSRTEXT"

    if [ "$KFN" = '/dev/null' ]
    then :
    elif [ "$KFN" != '' ]
    then umask 077
         outk > "$KFN"
    else outk
    fi
}

outk() {
    if [ "$NOPKEY" = no -o "$KEYPASS" != "" -o "$KEYPARAM" = yes ]
    then [ "$KEYPARAM" = no ] ||
	    echo "$SSKEY" | openssl pkeyparam 2>/dev/null ||:
	 echo "$SSKEY" | openssl pkey ${KEYPASS:+-des3 -passout "$KEYPASS"}
    else echo "$SSKEY"
    fi
}

[ "$KFN" = '' ] && umask 077
if [ "$FN" != '' ] ; then outp > "$FN" ; else outp ; fi
