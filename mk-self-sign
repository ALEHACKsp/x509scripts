#!/bin/bash -
if [ ! -n "$BASH_VERSION" ];then exec bash "$0" "$@";else set +o posix;fi
set -e

[ -s certs/ca.pem ] && { echo ERROR: CA already exists ; exit 1 ; }
mkdir -p certs 

# openssl genrsa -out certs/ca.key 3072
# openssl dsaparam -genkey -out certs/ca.key 3072

# openssl genpkey -paramfile <(openssl genpkey -genparam -algorithm ec -pkeyopt ec_paramgen_curve:prime256v1) -out certs/ca.key
# openssl ecparam -name prime256v1 -genkey | openssl pkey -out certs/ca.key

# openssl ecparam -name secp256k1 -genkey -out certs/ca.key
openssl ecparam -name prime256v1 -genkey -out certs/ca.key

if [ $# -gt 0 ] ; then
    SUBJ="$*" ;
    case "$SUBJ" in */* ) ;; "" ) SUBJ="/" ;; * )
	if [ "${#SUBJ}" -le 64 ]
	then SUBJ="/CN=$SUBJ/"
	elif [ "${#SUBJ}" -le 32768 ]
	then SUBJ="/name=$SUBJ/"
	else SUBJ="/unstructuredName=$SUBJ/"
	fi
    ;; esac
else unset SUBJ
fi

KEY=-key ; [ -s certs/ca.key ] || KEY="-nodes -keyout"
openssl req -new -x509 -days "${CERT_DAYS:-3652}" \
    ${SUBJ:+-subj "$SUBJ"} \
    $KEY certs/ca.key -out certs/ca.crt -config <(echo '
[req]
distinguished_name = req_distinguished_name
[ req_distinguished_name ]
organizationalUnitName = Organizational Unit Name
commonName = Common Name' )

{
    openssl x509 -text -certopt no_sigdump -in certs/ca.crt
    openssl pkey -in certs/ca.key
}> certs/ca.pem
