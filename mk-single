#!/bin/bash -
if [ ! -n "$BASH_VERSION" ];then exec bash "$0" "$@";else set +o posix;fi
set -e

if [ "$#" -lt 1 ]
then
    echo >&2 Usage: "$0: commonName [SAN names]"
    exit 1
fi

CN="$1"
SANLIST="$*"
F="${CN:-_}"
case "$F" in \*.?* ) F=${F#??} ;; esac
F=$(echo "$F" | tr -c '[a-zA-Z0-9\.\-\012]' _)

CERTSERIAL=$(openssl rand -hex 8)

build_xt() {

    cat <<-!
	[ x509_pol ]
	policyIdentifier =  2.5.29.32.0
	userNotice=@notice
	[ notice ]
!

    {
	echo
	echo 'Only one certificate was signed by this CA.'
	echo 'The serial number of that certificate is:'
	echo "$CERTSERIAL"
	echo
	echo 'The common name and alternative names on the certificate are:'
	for h in ${SANLIST}
	do echo '    '$h
	done

    } | sed -e '1s/^/explicitText=/' -e 's:$:\\r\\n\\:'

    echo
}

CAPEM="$(bash mk-self-sign \
    "/CN=Private CA for $CN/" \
    -days=3652 \
    -rsa \
    -serial="01$CERTSERIAL" \
    -v3='basicConstraints=CA:TRUE, pathlen:0' \
    -v3='keyUsage=keyCertSign' \
    -v3='certificatePolicies=@x509_pol' \
    -v3xt="$(build_xt)" )"

PEMFILE="$(bash mk-self-sign -rsa \
    -sign=<(echo "$CAPEM") \
    -serial="$CERTSERIAL" \
    "$CN" -san="${SANLIST// /,}" )"

################################################################################

TMP=x_tmp

mkcacrlconf() {
    echo '[ca]'
    echo 'default_ca = CA_default'
    echo '[CA_default]'
    echo "database = $TMP.index.txt"
    echo 'default_md = default'
}

touch $TMP.index.txt
touch $TMP.index.txt.attr

CRLFILE="$(
    openssl ca \
	-config <(mkcacrlconf) \
	-gencrl \
	-crldays 3652 \
	-keyfile <(echo "$CAPEM") \
	-cert <(echo "$CAPEM") )"

rm "$TMP".*

################################################################################

mkdir -p navcert
echo "$CAPEM" | openssl x509 -subject -serial -dates > navcert/"$F".ca.crt
echo "$CRLFILE" > navcert/"$F".crl
echo "$PEMFILE" > navcert/"$F".pem

openssl pkcs12 -export -in navcert/"$F".pem -certfile navcert/"$F".ca.crt \
    -passout pass: -out navcert/"$F".pfx

