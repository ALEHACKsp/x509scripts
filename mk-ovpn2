#!/bin/bash -
if [ ! -n "$BASH_VERSION" ];then exec bash "$0" "$@";else set +o posix;fi

[ -d certs ] || { echo >&2 ERROR: Certificate directory missing ; exit 1;}

umask 077

build_files() {

mkdir -p tmp

# Add all the server CA certificates.
for CA in certs/*.ca.cer
do
    [ -s "$CA" ] &&
	openssl x509 -subject -serial -dates -in "$CA"
done > tmp/servers.ca-list.pem

try_file certs servers.ca-list.pem

[ -s certs/servers.ca-list.pem ] || {
    echo >&2 ERROR: No servers have been defined.
    exit 1
}

mkdir -p ovpn-conf

# Need one of these to create the client files correctly.
[ -f certs/tls-crypt.pvk ] ||
    openvpn --genkey --secret certs/tls-crypt.pvk

# For all the client CA certificates
for cert in certs/*.ca.crt
do
    CN="$(basename "$cert" .ca.crt)"
    CA="certs/$CN.ca.crt"
    [ -s certs/"$CN".key -a -s "$CA" ] && {

	echo Client $CN

	for file in pattern*.ovpn
	do
	    tfile="$CN${file/pattern/}"

	    {
		cat "$file"

		[ -s certs/tls-crypt.pvk ] && {
		    if ! grep -q tls-auth "$file"
		    then
			echo '<tls-crypt>'
			cat certs/tls-crypt.pvk
			echo '</tls-crypt>'
		    fi
		}

		echo '<cert>'
		openssl x509 -subject -serial -dates -in certs/"$CN".crt
		echo '</cert>'

		echo '<key>'
		openssl pkey -in certs/"$CN".key
		echo '</key>'

		echo '<ca>'
		cat certs/servers.ca-list.pem
		echo '</ca>'

	    } > tmp/"$tfile"

	    try_file ovpn-conf "$tfile"
	done
    }
done

# Add all the client CA certificates
for cert in certs/*.ca.crt
do
    CN="$(basename "$cert" .ca.crt)"
    CA="certs/$CN.ca.crt"
    [ -s certs/"$CN".crt -a -s "$CA" ] && {
	openssl x509 -subject -serial -dates -in "$CA"
	echo
    }
done > tmp/clients.ca-list.pem

try_file certs clients.ca-list.pem

# Copy all the certificates and keys for the servers.
for cert in certs/*.ca.cer
do
    CN="$(basename "$cert" .ca.cer)"
    [ -s certs/"$CN".key ] && {
	echo Server $CN

	openssl x509 -subject -serial -dates -in certs/"$CN".crt > tmp/"$CN".crt
	openssl pkey -in certs/"$CN".key > tmp/"$CN".key

	cp -p certs/clients.ca-list.pem tmp/"$CN".ca-list.pem

	cp -p certs/tls-crypt.pvk tmp/"$CN".tls-crypt.pvk

	try_file ovpn-conf "$CN".crt
	try_file ovpn-conf "$CN".key
	try_file ovpn-conf "$CN".ca-list.pem
	try_file ovpn-conf "$CN".tls-crypt.pvk

	[ -f certs/dhparam.pem ] && {
	    cp -p certs/dhparam.pem tmp/"$CN".dhparam.pem
	    try_file ovpn-conf "$CN".dhparam.pem
	}
    }
done

rm -rf tmp
}

try_file() {
    [ ! -s "$1"/"$2" ] &&
	cp -p tmp/"$2" "$1"/"$2"
    if ! cmp -s tmp/"$2" "$1"/"$2"
    then cp -p tmp/"$2" "$1"/"$2"
    fi
    [ -f tmp/"$2" ] && rm tmp/"$2"
}

build_files
